# CHANGELOG

## [No Version] - 2025-02-11

### Added
- Implementación de gestión de suscriptores VIP con paginación y revocación de acceso
- Implementación de envío de publicaciones con reacciones opcionales a canales VIP y gratuitos
- Implementación de configuración de reacciones inline personalizadas para canales VIP y gratuitos
- Implementación de MenuFactory para UI estandarizada en menús
- Implementación de tiempos de espera personalizados para solicitudes de canales gratuitos
- Sistema de gestión de tarifas de suscripción con creación, edición y eliminación
- Configuración de canales VIP y gratuitos con validación de administrador
- Sistema de tokens de suscripción VIP con generación y canje
- Sistema de acceso gratuito con colas y tiempos de espera
- Gestión de roles de usuario (free, vip, admin)
- Estadísticas de usuarios y solicitudes
- Dashboard de estadísticas con vistas detalladas (general, VIP, free)
- Servicio StatsService para recuperación y agregación de estadísticas
- Middlewares de autenticación y base de datos
- Base de datos con SQLAlchemy y modelos ORM
- Estados FSM para flujos de configuración
- Servicios de suscripción, canales y configuración
- Funcionalidad de procesamiento masivo de solicitudes pendientes de acceso gratuito
- Opción "Configurar Tarifas" en menú VIP para gestión directa de tarifas
- Callback `process_pending_now` para procesamiento manual de solicitudes pendientes
- Método `process_pending_requests` en ChannelManagementService para aprobación masiva
- Método `approve_request` en ChannelManagementService para aprobación individual
- Documentación detallada de la estructura de menús en MENU_STRUCTURE.md
- Implementación completa del menú jerárquico con navegación estándar
- Submenús de configuración para canales VIP y gratuito
- Opción "Configurar Reacciones" directamente en menús VIP y Free
- Opción "Configurar Tiempo de Espera" directamente en menú Free
- Funcionalidad de "Configurar" como submenú en menús VIP y Free
- Actualización de documentación para reflejar la estructura completa de menús
- Patrón de Inyección de Dependencias con ServiceContainer para acceso centralizado a servicios
- Servicio NotificationService para envío de mensajes basados en plantillas
- Patrón Event Bus con implementación de EventBus y constantes Events para comunicación desacoplada
- Funcionalidad de protección de contenido para canales VIP y Free
- Columnas vip_content_protection y free_content_protection en la tabla bot_config
- Métodos toggle_content_protection y get_content_protection_status en ConfigService
- Opciones de activación/desactivación de protección de contenido en menús VIP y Free
- Sistema de gamificación con modelos Rank y GamificationProfile
- Modelos Rank y GamificationProfile para sistema de puntos y rangos
- Funcionalidad de seed data para inicializar rangos predeterminados en la base de datos
- Plantillas de notificación para eventos de gamificación (welcome_gamification, score_update, reward_unlocked)
- Rangos predeterminados: Bronce, Plata, Oro, Platino y Diamante con puntos y recompensas
- GamificationService: Servicio completo de gamificación que otorga puntos automáticamente por reacciones y notifica subidas de rango
- Integración del GamificationService con Event Bus para escuchar eventos de reacción
- Sistema automatizado de notificaciones para subidas de rango
- Método setup_listeners en GamificationService para suscribirse a eventos relevantes
- Handler `process_inline_reaction` para procesar reacciones inline de usuarios
- Implementación completa del flujo de gamificación: reacción → puntos → rank-ups
- Desacoplamiento entre capa de UI y lógica de negocio a través del EventBus
- Actualización de documentación para reflejar el nuevo patrón de desacoplamiento
- Nuevo modelo RewardContentPack para contener packs de contenido como recompensas
- Nuevo modelo RewardContentFile para archivos individuales dentro de packs de contenido
- Actualización del modelo Rank con campos reward_vip_days y reward_content_pack_id para recompensas avanzadas
- Implementación de relaciones entre rangos y packs de contenido para recompensas personalizadas
- Nuevo FSM ContentPackCreationStates para el flujo de creación de packs de contenido
- Métodos GamificationService: create_content_pack, add_file_to_pack, get_all_content_packs, delete_content_pack
- Nuevo handler admin_content_packs_menu para gestión de packs de contenido
- Nuevo handler start_pack_creation para iniciar el flujo de creación de packs
- Nuevo handler process_pack_name para procesar el nombre del pack
- Nuevo handler process_media_file para procesar archivos multimedia
- Nuevo handler finish_pack_creation para finalizar la creación de packs
- Integración con menú VIP añadiendo opción "Packs de Recompensas"
- Soporte para subida de fotos, videos y documentos como contenido multimedia
- Infraestructura de contexto de retorno para flujos de creación anidados
- Nuevo FSM RankConfigStates para el flujo de configuración de recompensas de rangos
- Métodos GamificationService: get_all_ranks, update_rank_rewards, get_rank_by_id para gestión de rangos
- Nuevo handler vip_manage_ranks_menu para mostrar y gestionar rangos
- Nuevo handler rank_edit_detail para editar detalles de rangos
- Nuevo handler rank_set_vip_days_start para iniciar el flujo de configuración de días VIP
- Nuevo handler process_vip_days_input para procesar la entrada de días VIP
- Nuevo handler rank_set_pack_start para iniciar el flujo de asignación de packs
- Nuevo handler rank_bind_pack para vincular packs a rangos
- Nuevo handler rank_create_pack_nested para creación anidada de packs desde rangos
- Integración con menú VIP añadiendo opción "Rangos" para gestión de recompensas
- Sistema de edición de recompensas por rango (días VIP y packs de contenido)
- Sistema de contexto de retorno para mantener el flujo lógico durante creación anidada
- Implementación del sistema de entrega automática de recompensas al subir de rango
- Método `_deliver_rewards` en GamificationService para procesar y entregar recompensas configuradas
- Entrega automática de días VIP mediante `subscription_service.add_vip_days` cuando se sube de rango
- Entrega automática de packs de contenido multimedia como álbum o archivos individuales
- Clasificación inteligente de archivos multimedia para envío apropiado como álbum o archivos individuales
- Nuevas plantillas de notificación "vip_reward" y "pack_reward" para informar sobre recompensas entregadas
- Integración del sistema de entrega de recompensas con `_check_rank_up` para activación automática
- Manejo específico de errores en envío de recompensas sin afectar el flujo principal de gamificación
- Actualización de documentación para reflejar el nuevo sistema de entrega de recompensas
- Nuevo campo last_daily_claim en GamificationProfile para rastrear recompensas diarias
- Nuevas plantillas de notificación "daily_success" y "daily_cooldown" para el sistema de recompensas diarias
- Método claim_daily_reward en GamificationService con lógica de cooldown de 24 horas
- Nuevo comando /daily en el handler de usuarios para permitir a los usuarios reclamar su recompensa diaria
- Recompensa fija de 50 puntos por check-in diario exitoso
- Validación y manejo de errores apropiado en el servicio de gamificación para el sistema diario

### Changed
- Alineación de tiempo de espera para canales gratuitos a especificaciones
- Mejora del flujo de bienvenida para usuarios gratuitos (sin enlace de invitación)
- Mejora del flujo de registro de canales (VIP & Free)
- Implementación de actualización robusta de configuración con mensajes de error
- Actualización del flujo de interacción con suscriptores VIP incluyendo generación de enlaces de invitación
- Refactorización a niveles de tokens basados en suscripción
- Implementación de CRUD para SubscriptionTier en ConfigService
- **PR12**: Mejora del flujo de envío de publicaciones con mejor manejo de errores
- **PR12**: Consolidación de código duplicado en servicios
- **PR12**: Mejora de la seguridad de tipos con anotaciones apropiadas
- **PR12**: Mejora del manejo de excepciones en servicios y handlers
- **PR12**: Implementación de método compartido para obtener reacciones en ConfigService
- **PR12**: Reorganización de importaciones para seguir estilo PEP 8
- **PR12**: Mejora de la validación de tipo de canal para prevenir publicación en canal incorrecto
- **PR23**: Añadida la plantilla "rank_up" al NotificationService para notificar subidas de rango
- **PR23**: Mejoras a GamificationService con type hints, constantes y mejor manejo de errores
- **PR23**: Corrección de datetime.now en GamificationProfile modelo para usar timezone.utc
- **PR23**: Uso de SQLAlchemy ORM en la función seed_ranks para inicializar datos de manera más eficiente
- **PR23**: Eliminación de variables no utilizadas en GamificationService
- **PR23**: Mejora de eficiencia en la consulta _check_rank_up con uso de limit(1)
- **PR23**: Implementación de constantes como POINTS_PER_REACTION para valores fijos en GamificationService
- **PR23**: Mejoras de manejo de errores con SQLAlchemyError y manejo específico de errores de Telegram

### Fixed
- Resolución de problemas de comparación de datetime y atributos de configuración
- Manejo robusto de errores para generación de enlaces de invitación
- Resolución de problemas en actualización de configuración y parseo de mensajes de error
- Correcciones de estilo y comentarios en código
- Solución de problemas de inicialización de base de datos
- **PR12**: Corrección de problemas en el servicio de configuración con funciones sueltas
- **PR12**: Mejora de la validación de tipos de canales en servicios
- **PR23**: Corrección del problema de zona horaria en GamificationProfile modelo
- **PR24**: Corrección del bug de `new_expiry` en SubscriptionService donde no se calculaba correctamente la fecha de expiración al extender suscripciones
- **PR24**: Implementación de manejo específico de excepciones `TelegramAPIError` para errores de la API de Telegram en lugar de capturar todas las excepciones genéricas
- **PR24**: Eliminación de objetos mock en la gestión de rangos para mejorar la claridad del código
- **PR24**: Implementación de eliminación en cascada ORM en GamificationService para eliminar packs de contenido y sus archivos asociados